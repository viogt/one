<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>âœŽ Rich Email</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<style type="text/css">
P { font: normal 14pt Ubuntu,Calibri,sans-serif; padding-bottom: 20px; }
i { border-bottom: 2px solid orange; font-style: normal; }

.Inp { background-color: white; border: 1px solid lightgrey; border-radius:6px;
        font-size: 14px; width:28px;height:28px; margin-bottom:16px;
}
.Inp:hover { border-color:red; cursor:pointer; }

</style>
<script type="text/javascript">

function id(x) { return document.getElementById(x); }

function inCorp(_cont) { setCont(_cont); goTo('end'); }
function inCorpDB(_cont) { const j = JSON.parse(_cont); setCont(j.content); goTo('end'); }

function setCont(_cnt) {
  if(totFiles[curFile].type == 'html') {
    id('Continut').innerHTML = _cnt;
    totFiles[curFile].depot = _cnt;
  }
  else {
    id('Continut').textContent = _cnt;
    totFiles[curFile].depot = _cnt;
  }
}

function Http( _btn, _meth, _resrc, _msg, _callback){
  try {
      if(_btn) _btn.style.backgroundColor = '#FF0';
      const http = new XMLHttpRequest();
      http.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
                if(http.responseText.charAt(0) == '0') { alert('Error: ' + http.responseText.substr(1)); return; }
                if(_callback) _callback(http.responseText);
                if(_btn) _btn.style.backgroundColor = '';
                return;
          }
      };
      http.open(_meth, _resrc, true); http.send(_msg);
  } catch(e) { alert('ERROR: ' + e.message); return; } 
}

function getCnt() { return (totFiles[curFile].type == 'html')?id('Continut').innerHTML:id('Continut').textContent; }

function Save(bt) { Http(bt, 'POST', totFiles[curFile].name, getCnt(), null); }

function goTo( ps ) {
	if(ps == 'top') window.scrollTo(0,0);
	else if(ps == 'end') window.scrollTo(0, document.body.scrollHeight);
	else window.scrollTo(0, Math.floor(document.body.scrollHeight/2));
}

function Receive() { Http(null, 'GET', totFiles[curFile].name, 'x', inCorp); }

var isDirty = false;
window.addEventListener("beforeunload", function(event) {
  if(isDirty) event.returnValue = "Do you want to quit changes?";
});

//-----------------------------------------------------------------------
function saveMng(bt) {
  const msg = JSON.stringify({ action: 'save', file: totFiles[curFile].name, content: getCnt(), collection: 'files' });
  Http(bt, 'POST', 'mng', msg, null);
}

function readMng(bt) {
  const msg = JSON.stringify({ action: 'get one', file: totFiles[curFile].name, collection: 'files' });
  Http(bt, 'POST', 'mng', msg, inCorpDB);
}

function culege(v) {
	const s = v.trim().replace(/\?/g,"\\w").replace(/\*/g,"\\w*");
  const rgx = new RegExp("^(.*\\b" + s + "\\b.*)$",'gim');
	const res = id('source').textContent.match(rgx);
  id('Res').textContent = res?res.join('\n\n'):'> NOT FOUND!';
}

var curFile = 0, totFiles = [ {name:'eng.txt', depot:null, type:'html'}, {name:'rand.txt',depot:null, type:'text'} ];

function toggleFiles() {
  curFile++; if(curFile >= totFiles.length) curFile = 0;
  if( totFiles[curFile].depot ) {
    if(totFiles[curFile].type == 'html') id('Continut').innerHTML = totFiles[curFile].depot;
    else id('Continut').textContent = totFiles[curFile].depot;
  }
  else Receive();
}
</script>

</head>
<body onLoad='Receive()' style='margin:10px; margin-left:42px;'>

<div style='position:fixed;left:3px;top:10px;'>

  <button onClick='goTo("top")' title='Search' class="Inp fa fa-search"></button><br><br>

  <button onClick='goTo("top")' title='To the top' class="Inp fa fa-arrow-up"></button><br>
  <button onClick='goTo("middle")' title='To the middle' class="Inp fa fa-unsorted"></button><br>
  <button onClick='goTo("end")' title='To the bottom' class="Inp fa fa-arrow-down"></button><br><br>

  <button onClick='Save(this)' title='Save content' class="Inp fa fa-save"></button><br>
  <a href='down/eng.txt' title='Download the file' class='Inp fa fa-download' style='color:#000; padding-top:10px; text-decoration:none; text-align:center;'></a><br><br>

  <button onClick='saveMng(this)' title='Save to DB' class="Inp fa fa-pencil"></button><br>
  <button onClick='readMng(this)' title='Read from DB' class="Inp fa fa-upload"></button><br>
</div>

<DIV id='Continut' contentEditable='true' onInput="isDirty=true;" style='outline:none;'></DIV>

</body>
</html>